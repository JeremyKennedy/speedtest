<!DOCTYPE html>
<html>
<head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>

    function add(str) { $("#output").append(str); }

    var download_sum_size=0;
    var download_sum_time=0;
    var upload_sum_size=0;
    var upload_sum_time=0;

    var blob=false;

    function speedtest(size,repeat)
    {
        var start;
	var stop;
   	var speed;
   	var time;
        var d;
	add("Download: "+size+" MByte --&gt; ");
	d=new Date();
	start=d.getTime();
        $.get("blob/"+size,function() {
	    d=new Date();
	    stop=d.getTime();
	    time=stop-start;
	    speed=(1000/time*size);
	    add(time+" msec "+speed.toFixed(2)+" MByte/s <br>");
	    if (time<=500 && repeat==0) { speedtest(size*2,0); }
	    else {
		download_sum_size+=size;
		download_sum_time+=time;
		if(repeat==4) {
		   $("#result").html("Download: "+download_sum_size+" MByte in "+download_sum_time/1000+" seconds : "+
				     (download_sum_size/download_sum_time*1000*8).toFixed(2)+" Mbit/s<br>");
		   speedtest_upload(0.1,0);
		}
		else speedtest(size,repeat+1);
	    }
	})
	.fail(function () { $("#result").text("Speedtest failed"); });
    }

    function speedtest_upload(size,repeat)
    {
        var start;
	var stop;
   	var speed;
   	var time;
        var d;
	add("Upload: "+size+" MByte --&gt; ");
	d=new Date();
	start=d.getTime();

	var upload_data=blob;
	for (var i=1;i<size;i++) upload_data+=blob;

        $.ajax({ type: "POST", url: "blob/", contentType: 'application/octet-stream',
	  	 data: upload_data, processData:false })
	    .done(function(data) {
	        d=new Date();
	        stop=d.getTime();
	        time=stop-start;
	        speed=(1000/time*size);
	        add(time+" msec "+speed.toFixed(2)+" MByte/s <br>");
	        if (time<=500 && repeat==0) { speedtest_upload(size*2,0); }
	        else
		{
		    upload_sum_size+=size;
		    upload_sum_time+=time;
		    if(repeat==4) {
		       $("#result").append("Upload: "+upload_sum_size+" MByte in "+upload_sum_time/1000+" seconds : "+
				           (upload_sum_size/upload_sum_time*1000*8).toFixed(2)+" Mbit/s<br>");
		    }
		    else speedtest_upload(size,repeat+1);
	        }
	    })
	    .fail(function () { $("#result").text("Speedtest failed"); });
    }

    function generate_random_data(len)
    {
	var chars = "!@#$%*()-_=+][{}|;:'~`<>.,/?\\\"0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
        var randomstring = '';
        for (var i=0; i<len; i++) {
            var rnum = Math.floor(Math.random() * chars.length);
            randomstring += chars.substring(rnum,rnum+1);
        }
	return randomstring;
    }

    $(document).ready(function () {
	$("button").click(function () {  $("div").html(""); speedtest(1,0); });
	blob=generate_random_data(1024*1024);
    });

</script>

<style>
    body { font-family: sans-serif; margin:20px; }
    div { margin:20px; }
    div#result { font-size:1.5em; }
</style>

</head>
<body>
    <h1>Speedtest</h1>
    <button ()>Start</button>
    <div id=result></div>
    <div id=output></div>
</body>
</html>
